/**
 * STORM CHASING TYCOON - GAME ENGINE
 */

const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');

// DIE WELT: Eine riesige Karte (4000x3000 Pixel)
canvas.width = 4000;
canvas.height = 3000;

let money = 0;
let collectedData = 0;
let gameOver = false;

// GRAFIKEN LADEN (Echte Bilder)
const imgSUV = new Image();
imgSUV.src = 'https://cdn-icons-png.flaticon.com/512/744/744465.png';

const imgDominator = new Image();
imgDominator.src = 'https://cdn-icons-png.flaticon.com/512/2739/2739667.png';

const imgTornado = new Image();
imgTornado.src = 'https://cdn-icons-png.flaticon.com/512/1146/1146860.png';

// STRASSEN-SYSTEM (Echte Highways und Landstraßen)
const roads = [
    {x: 0, y: 1450, w: 4000, h: 120, type: 'asphalt'}, // Zentraler Highway (E-W)
    {x: 1940, y: 0, w: 120, h: 3000, type: 'asphalt'}, // Zentraler Highway (N-S)
    {x: 0, y: 400, w: 2000, h: 60, type: 'dirt'},     // Landweg oben links
    {x: 2000, y: 2400, w: 2000, h: 60, type: 'dirt'}   // Landweg unten rechts
];

// SPIELER-OBJEKT
let player = {
    x: 2000,
    y: 2800,
    width: 65,
    height: 35,
    baseSpeed: 3.2,
    isInterceptor: false,
    hp: 100,
    maxHp: 100
};

// TORNADO-OBJEKT
let tornado = {
    x: 2000,
    y: -600,
    size: 200,
    speed: 0.25, // EXTREM LANGSAM (für Realismus)
    windSpeed: 110,
    efScale: "EF1",
    rotation: 0
};

// SONDE
let probe = { x: -100, y: -100, active: false };

// TASTATUR-EINGABE
let keys = {};
window.onkeydown = (e) => { keys[e.key.toLowerCase()] = true; };
window.onkeyup = (e) => { keys[e.key.toLowerCase()] = false; };
window.onkeypress = (e) => { if(e.code === 'Space') deployProbe(); };

function deployProbe() {
    if(!probe.active && !gameOver) {
        probe.x = player.x;
        probe.y = player.y;
        probe.active = true;
    }
}

function buyInterceptor() {
    if (money >= 500 && !player.isInterceptor) {
        money -= 500;
        player.isInterceptor = true;
        player.baseSpeed = 4.8;
        player.hp = 800;
        player.maxHp = 800;
        const btn = document.getElementById('buyBtn');
        btn.innerText = "DOMINATOR 3 AKTIV";
        btn.classList.add('unlocked');
    }
}

// HINTERGRUND UND KARTE ZEICHNEN
function drawMap() {
    // 1. Dunkle Grasfläche (Realistischer Untergrund)
    ctx.fillStyle = "#1b2610";
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    // 2. Straßen zeichnen
    roads.forEach(road => {
        ctx.fillStyle = road.type === 'asphalt' ? "#333" : "#5d4a37";
        ctx.fillRect(road.x, road.y, road.w, road.h);
        
        // Mittelstreifen für Asphaltstraßen
        if (road.type === 'asphalt') {
            ctx.strokeStyle = "#ffd700";
            ctx.setLineDash([30, 30]);
            ctx.lineWidth = 3;
            ctx.beginPath();
            if (road.w > road.h) {
                ctx.moveTo(road.x, road.y + road.h/2);
                ctx.lineTo(road.x + road.w, road.y + road.h/2);
            } else {
                ctx.moveTo(road.x + road.w/2, road.y);
                ctx.lineTo(road.x + road.w/2, road.y + road.h);
            }
            ctx.stroke();
            ctx.setLineDash([]);
        }
    });

    // 3. Häuser (Viel mehr für Realismus)
    for(let i=0; i<40; i++) {
        let hX = (i * 750) % 3800 + 100;
        let hY = (i * 550) % 2800 + 100;
        // Nicht auf Straßen bauen
        if (!(hX > 1800 && hX < 2100) && !(hY > 1400 && hY < 1600)) {
            drawDetailedHouse(hX, hY);
        }
    }
}

function drawDetailedHouse(x, y) {
    ctx.fillStyle = "#4a3c31"; 
    ctx.fillRect(x, y, 90, 70); // Wand
    ctx.fillStyle = "#111"; 
    ctx.fillRect(x + 15, y + 20, 20, 20); // Fenster links
    ctx.fillRect(x + 55, y + 20, 20, 20); // Fenster rechts
    ctx.fillStyle = "#721a1a"; // Dach
    ctx.beginPath();
    ctx.moveTo(x - 10, y);
    ctx.lineTo(x + 45, y - 45);
    ctx.lineTo(x + 100, y);
    ctx.fill();
}

function respawnTornado() {
    tornado.y = -600;
    tornado.x = 400 + Math.random() * 3200;
    let roll = Math.random();
    if(roll > 0.9) {
        tornado.efScale = "EF5"; tornado.size = 350; tornado.windSpeed = 480; tornado.speed = 0.2;
    } else if(roll > 0.6) {
        tornado.efScale = "EF2"; tornado.size = 180; tornado.windSpeed = 210; tornado.speed = 0.25;
    } else {
        tornado.efScale = "EF1"; tornado.size = 120; tornado.windSpeed = 125; tornado.speed = 0.3;
    }
}

function update() {
    if(gameOver) return;

    // Check: Ist der Spieler auf einer Straße?
    let onRoad = roads.some(r => player.x > r.x && player.x < r.x + r.w && player.y > r.y && player.y < r.y + r.h);
    let speedMult = onRoad ? 1.0 : (player.isInterceptor ? 0.7 : 0.35);
    let currentSpeed = player.baseSpeed * speedMult;

    // Bewegung
    if (keys['w']) player.y -= currentSpeed;
    if (keys['s']) player.y += currentSpeed;
    if (keys['a']) player.x -= currentSpeed;
    if (keys['d']) player.x += currentSpeed;

    // Tornado-Bewegung
    tornado.y += tornado.speed;
    tornado.rotation += 0.02;

    if (tornado.y > canvas.height + 600) respawnTornado();

    // KAMERA: Den Viewport auf das Auto zentrieren
    const viewport = document.getElementById('game-viewport');
    viewport.scrollLeft = player.x - window.innerWidth / 2;
    viewport.scrollTop = player.y - window.innerHeight / 2;

    // Kollision Spieler & Tornado
    let dist = Math.hypot(tornado.x - player.x, tornado.y - player.y);
    if (dist < tornado.size / 2.5) {
        let dmg = player.isInterceptor ? 0.15 : 4.5;
        player.hp -= dmg;
        if (player.hp <= 0) {
            gameOver = true;
            alert("Dein Fahrzeug wurde vom Tornado zerfetzt!");
            location.reload();
        }
    }

    // Datensammeln
    if (probe.active) {
        let pDist = Math.hypot(tornado.x - probe.x, tornado.y - probe.y);
        if (pDist < tornado.size / 1.5) {
            collectedData += 0.45;
            if (collectedData >= 100) {
                money += 350 + (tornado.windSpeed / 1.5);
                collectedData = 0;
                probe.active = false;
            }
        }
    }

    updateUI();
}

function updateUI() {
    document.getElementById('money').innerText = Math.floor(money);
    document.getElementById('data').innerText = Math.floor(collectedData);
    const btn = document.getElementById('buyBtn');
    if(money >= 500 && !player.isInterceptor) btn.classList.add('affordable');
}

function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    drawMap();

    // Sonde
    if (probe.active) {
        ctx.fillStyle = "red"; ctx.beginPath(); ctx.arc(probe.x, probe.y, 10, 0, 7); ctx.fill();
        ctx.fillStyle = "white"; ctx.fillRect(probe.x - 2, probe.y - 20, 4, 20); // Antenne
    }

    // Spieler-Auto zeichnen
    ctx.save();
    ctx.translate(player.x, player.y);
    const currentImg = player.isInterceptor ? imgDominator : imgSUV;
    ctx.drawImage(currentImg, -player.width/2, -player.height/2, player.width, player.height);
    ctx.restore();

    // HP-Balken über dem Auto
    ctx.fillStyle = "#000"; ctx.fillRect(player.x - 30, player.y - 45, 60, 10);
    ctx.fillStyle = "lime"; ctx.fillRect(player.x - 30, player.y - 45, 60 * (player.hp / player.maxHp), 10);

    // Tornado zeichnen (Bild + Rotation)
    ctx.save();
    ctx.translate(tornado.x, tornado.y);
    ctx.rotate(tornado.rotation);
    ctx.globalAlpha = 0.75;
    ctx.drawImage(imgTornado, -tornado.size/2, -tornado.size/2, tornado.size, tornado.size);
    ctx.restore();

    // Tornado-Informationen
    ctx.fillStyle = "white";
    ctx.font = "bold 28px Arial";
    ctx.fillText(tornado.efScale + " (" + tornado.windSpeed + " km/h)", tornado.x - 80, tornado.y - tornado.size/2 - 20);
}

function loop() {
    update();
    draw();
    requestAnimationFrame(loop);
}

// Start des Spiels
loop();